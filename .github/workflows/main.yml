name: Linux Ghost Kernel Build

permissions:
  contents: write

on:
  push:
    branches: [ master, main ]
    paths:
      - 'PKGBUILD'
      - 'config/**'
      - 'patches/**'
      - 'nvidia/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (e.g., 6.18.1)'
        required: false
        default: ''

jobs:
  validate:
    name: Validate PKGBUILD
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PKGBUILD syntax
        run: namcap PKGBUILD || true

      - name: Check PKGBUILD sources
        run: |
          source ./PKGBUILD
          echo "Kernel version: ${pkgver}"
          echo "Package base: ${pkgbase}"

  build:
    name: Build Kernel
    needs: validate
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download sources
        run: makepkg -od --noconfirm --skipinteg

      - name: Build kernel (config only)
        run: makepkg -o --noconfirm --skipinteg
        env:
          _localmodcfg: "no"
          _nvidia_bundle: "no"

      - name: Upload config artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-config
          path: src/linux-*/.config
          if-no-files-found: ignore

  release:
    name: Create Release
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          source PKGBUILD
          echo "version=${pkgver}-${pkgrel}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Linux Ghost ${{ steps.version.outputs.version }}
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
