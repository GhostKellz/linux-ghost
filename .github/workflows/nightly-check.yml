name: Nightly Upstream Check

on:
  schedule:
    # Run at 3 AM UTC daily
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no update'
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

jobs:
  check-upstream:
    name: Check for New Kernel Releases
    runs-on: self-hosted
    outputs:
      needs_update: ${{ steps.compare.outputs.needs_update }}
      update_to: ${{ steps.compare.outputs.update_to }}
      new_minor: ${{ steps.compare.outputs.new_minor }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: current
        run: |
          source ./PKGBUILD
          echo "major=${_major}" >> $GITHUB_OUTPUT
          echo "minor=${_minor}" >> $GITHUB_OUTPUT
          echo "version=${_major}.${_minor}" >> $GITHUB_OUTPUT
          echo "Current: ${_major}.${_minor}"

      - name: Check kernel.org stable
        id: kernelorg
        run: |
          # Get latest stable kernel version from kernel.org
          LATEST=$(curl -s https://www.kernel.org/releases.json | jq -r '.releases[] | select(.moniker == "stable") | .version' | head -1)
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "kernel.org stable: ${LATEST}"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          KERNELORG="${{ steps.kernelorg.outputs.latest }}"
          FORCE="${{ github.event.inputs.force_build }}"

          echo "=== Version Comparison ==="
          echo "Current PKGBUILD: ${CURRENT}"
          echo "kernel.org stable: ${KERNELORG}"
          echo "Force build: ${FORCE}"

          CURRENT_MAJOR=$(echo "$CURRENT" | cut -d. -f1,2)
          CURRENT_PATCH=$(echo "$CURRENT" | cut -d. -f3)
          KERNELORG_MAJOR=$(echo "$KERNELORG" | cut -d. -f1,2)
          KERNELORG_PATCH=$(echo "$KERNELORG" | cut -d. -f3)

          NEEDS_UPDATE="false"
          UPDATE_TO=""
          NEW_MINOR=""

          if [[ "$FORCE" == "true" ]]; then
            NEEDS_UPDATE="true"
            UPDATE_TO="$KERNELORG"
            NEW_MINOR="$KERNELORG_PATCH"
          elif [[ "$CURRENT_MAJOR" == "$KERNELORG_MAJOR" ]]; then
            if [[ "$KERNELORG_PATCH" -gt "$CURRENT_PATCH" ]]; then
              NEEDS_UPDATE="true"
              UPDATE_TO="$KERNELORG"
              NEW_MINOR="$KERNELORG_PATCH"
              echo "New patch release available: ${KERNELORG}"
            fi
          elif [[ "$KERNELORG_MAJOR" > "$CURRENT_MAJOR" ]]; then
            NEEDS_UPDATE="true"
            UPDATE_TO="$KERNELORG"
            NEW_MINOR="$KERNELORG_PATCH"
            echo "New major release available: ${KERNELORG}"
          fi

          echo "needs_update=${NEEDS_UPDATE}" >> $GITHUB_OUTPUT
          echo "update_to=${UPDATE_TO}" >> $GITHUB_OUTPUT
          echo "new_minor=${NEW_MINOR}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Nightly Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current PKGBUILD | ${{ steps.current.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| kernel.org stable | ${{ steps.kernelorg.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.compare.outputs.needs_update }}" == "true" ]]; then
            echo "‚ö†Ô∏è **Update available:** ${{ steps.compare.outputs.update_to }}" >> $GITHUB_STEP_SUMMARY
            echo "üöÄ **Auto-building release...**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Up to date**" >> $GITHUB_STEP_SUMMARY
          fi

  auto-update:
    name: Auto Update & Release
    needs: check-upstream
    if: needs.check-upstream.outputs.needs_update == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Update PKGBUILD version
        run: |
          NEW_VERSION="${{ needs.check-upstream.outputs.update_to }}"
          NEW_MINOR="${{ needs.check-upstream.outputs.new_minor }}"
          NEW_MAJOR=$(echo "$NEW_VERSION" | cut -d. -f1,2)

          echo "Updating to kernel ${NEW_VERSION}"

          # Update _minor in PKGBUILD
          sed -i "s/^_minor=.*/_minor=${NEW_MINOR}/" PKGBUILD

          # Update _major if changed
          CURRENT_MAJOR=$(grep "^_major=" PKGBUILD | cut -d= -f2)
          if [[ "$CURRENT_MAJOR" != "$NEW_MAJOR" ]]; then
            sed -i "s/^_major=.*/_major=${NEW_MAJOR}/" PKGBUILD
          fi

          echo "Updated PKGBUILD:"
          grep -E "^_major=|^_minor=" PKGBUILD

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add PKGBUILD
          git commit -m "chore: bump kernel to ${{ needs.check-upstream.outputs.update_to }}"
          git push

      - name: Create tag and trigger release
        run: |
          TAG="v${{ needs.check-upstream.outputs.update_to }}-1"
          echo "Creating tag: ${TAG}"

          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

          echo "üè∑Ô∏è Created tag ${TAG} - release workflow will build packages"
