name: Nightly Upstream Check

on:
  schedule:
    # Run at 3 AM UTC daily
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-upstream:
    name: Check for New Kernel Releases
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          source ./PKGBUILD
          echo "major=${_major}" >> $GITHUB_OUTPUT
          echo "minor=${_minor}" >> $GITHUB_OUTPUT
          echo "version=${_major}.${_minor}" >> $GITHUB_OUTPUT
          echo "Current: ${_major}.${_minor}"

      - name: Check kernel.org stable
        id: kernelorg
        run: |
          # Get latest stable kernel version from kernel.org
          LATEST=$(curl -s https://www.kernel.org/releases.json | jq -r '.releases[] | select(.moniker == "stable") | .version' | head -1)
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "kernel.org stable: ${LATEST}"

      - name: Check CachyOS linux-cachyos
        id: cachyos
        run: |
          # Get latest tag from CachyOS linux-cachyos repo
          LATEST=$(curl -s "https://api.github.com/repos/CachyOS/linux-cachyos/tags" | jq -r '.[0].name' | sed 's/^v//')
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "CachyOS latest tag: ${LATEST}"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          KERNELORG="${{ steps.kernelorg.outputs.latest }}"
          CACHYOS="${{ steps.cachyos.outputs.latest }}"

          echo "=== Version Comparison ==="
          echo "Current PKGBUILD: ${CURRENT}"
          echo "kernel.org stable: ${KERNELORG}"
          echo "CachyOS tag: ${CACHYOS}"

          # Extract major.minor from kernel.org (e.g., 6.18.2 -> 6.18)
          KERNELORG_MAJOR=$(echo "$KERNELORG" | cut -d. -f1,2)

          NEEDS_UPDATE="false"
          UPDATE_TO=""

          # Check if kernel.org has newer patch release for same major.minor
          CURRENT_MAJOR=$(echo "$CURRENT" | cut -d. -f1,2)
          CURRENT_PATCH=$(echo "$CURRENT" | cut -d. -f3)
          KERNELORG_PATCH=$(echo "$KERNELORG" | cut -d. -f3)

          if [[ "$CURRENT_MAJOR" == "$KERNELORG_MAJOR" ]]; then
            if [[ "$KERNELORG_PATCH" -gt "$CURRENT_PATCH" ]]; then
              NEEDS_UPDATE="true"
              UPDATE_TO="$KERNELORG"
              echo "New patch release available: ${KERNELORG}"
            fi
          elif [[ "$KERNELORG_MAJOR" > "$CURRENT_MAJOR" ]]; then
            # New major.minor release
            NEEDS_UPDATE="true"
            UPDATE_TO="$KERNELORG"
            echo "New major release available: ${KERNELORG}"
          fi

          echo "needs_update=${NEEDS_UPDATE}" >> $GITHUB_OUTPUT
          echo "update_to=${UPDATE_TO}" >> $GITHUB_OUTPUT
          echo "kernelorg_major=${KERNELORG_MAJOR}" >> $GITHUB_OUTPUT

      - name: Create issue if update available
        if: steps.compare.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.current.outputs.version }}';
            const updateTo = '${{ steps.compare.outputs.update_to }}';
            const kernelorg = '${{ steps.kernelorg.outputs.latest }}';
            const cachyos = '${{ steps.cachyos.outputs.latest }}';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'kernel-update'
            });

            const existingIssue = issues.data.find(i => i.title.includes(updateTo));
            if (existingIssue) {
              console.log(`Issue already exists for ${updateTo}: #${existingIssue.number}`);
              return;
            }

            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ†• Kernel ${updateTo} available`,
              labels: ['kernel-update'],
              body: `## New Kernel Release Detected

            | Source | Version |
            |--------|---------|
            | **Current PKGBUILD** | ${current} |
            | **kernel.org stable** | ${kernelorg} |
            | **CachyOS tag** | ${cachyos} |

            ### Action Required
            Update \`PKGBUILD\` version variables:
            \`\`\`bash
            _major=${updateTo.split('.').slice(0, 2).join('.')}
            _minor=${updateTo.split('.')[2] || '0'}
            \`\`\`

            ### Links
            - [kernel.org changelog](https://cdn.kernel.org/pub/linux/kernel/v${updateTo.split('.')[0]}.x/ChangeLog-${updateTo})
            - [CachyOS releases](https://github.com/CachyOS/linux-cachyos/releases)

            ---
            *This issue was automatically created by the nightly upstream check.*`
            });

            console.log(`Created issue for kernel ${updateTo}`);

      - name: Summary
        run: |
          echo "## Nightly Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current PKGBUILD | ${{ steps.current.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| kernel.org stable | ${{ steps.kernelorg.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CachyOS tag | ${{ steps.cachyos.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.compare.outputs.needs_update }}" == "true" ]]; then
            echo "âš ï¸ **Update available:** ${{ steps.compare.outputs.update_to }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Up to date**" >> $GITHUB_STEP_SUMMARY
          fi
